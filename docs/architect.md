# Overview
В крупном масштабе пусть будет несколько слоев.  
- расчет падения по дуге;
- поиск потокораспределения;
- смешение жидкостей, сепарация, автоматика;


### Расчет падения давления по дуге
Это самый нижний слой. Расчет падения давления по дуге, это вычисление давления на одном конце какого-то объекта, по известным потоку и давлению на другом конце. 
Здесь есть одно нетривальное требование, нужно чтобы на любом узле можно было задать отрицательное давление, и от него рассчитать падение. Это реализуется так: для расчета PVT свойств берем давление по модулю. Отсюда мы можем посчитать градиент давления, при отрицательном. 

### Поиск потокораспределения
Проще всего эту задачу решать с помощью МКР[^1] который просто балансирует массовые потоки и давления, и сбивает это всё с граничными условиями. На этом уровне про состав жидкостей вовсе не думаем, считаем что они на всех дугах графа заданы. Дуги здесь будут абстрактные, они просто умеют считать P2(P1, Q).
Тогда чтобы решить эту задачу нужно:
  - Модифицировать граф сети. Добавить фиктивный узел-корень с фиксированым P=0, протянуть от него фиктивные дуги к узлам с г.у. P=const или PQ-кривой, подменить г.у.[^2] на этих узлах;
  - Редуцировать пространство неизвестных, то есть выделить из графа хорды, избавиться от тривиальных лупингов;
  - Построить начальное приближение. Тут можно пробовать разные эвристики, но возможно лучше всего будет просто задать нули на хордах;
  - Задать функцию невязки 1го и 2го ЗК[^3]. Она может вычисляться например так:
    1. По заданым расходам на хордах восстанавливает все потоки 
    2. От узла с корнем (фиксированным давлением) восстанавливает все давления
    3. Считает потери давления по хордам, и из них невязки на хордах
    4. Считает какую-то норму вектора невязок и возвращает ее
  - Искать потокораспределение как решение задачи оптимизации в пространстве расходов на хордах. Функция невязки - ц.ф.[^4]. На первых этапах использовать scipy.optimize, если будет плохо, тогда запилить какой-нибудь свой метод.


### Cмешение жидкостей, сепарация, автоматика
На практике зачастую возникает необходимость учитывать в расчете потокораспределения на трубопроводных сетях еще и смешение жидкостей, работу проточных сепараторов, работу автоматических устройств. 
##### Смешение жидкостей
Эта задача возникает например при моделировании нефтесбора, когда со скважин идет нефть с разной обводненностью и газовым фактором. Или при транспортировке нефти с нескольких месторождений в одном потоке. Во втором случае недостаточно будет считать раздельно массовые потоки воды, нефти и газа, чего хватило бы в предыдущем случае, здесь нефти могут например иметь сильно отличающиеся плотность, вязкость и другие PVT-свойства.
Решается она так: при установившемся потокораспределении можно найти для каждого потока по дуге графа, долю в нем каждого источника. Потом скалярно умножить вектор входящих жидкостей на вектор долей потока.
##### Сепарация в потоке
Это например работа ПТВО, проточного трубного водоотделителя, в сети нефтесбора. Это наклонная труба большого объема, в которой входящий поток разделяется на два, выходящие из верхнего (условно нефть) и нижнего (условно вода) конца трубы. Ее работу можно моделировать, например, задавая зависимость обводненности выходящей нефти, от обводненности и потока на входе.
##### Автоматика
Пример - устройство контроля давления, по сути просто задвижка с датчиком, которая прикручивается если давление выходит за границу заданой уставки.


Эти и подобные задачи можно решать и в рамках задачи поиска потокораспределения, но практика показывает что решение будет плохо сходиться. Лучше вынести их в отдельный слой и решать поверх стационарной задачи, небольшим шагом.

##### Примечания
[^1]: МКР - метод контурных раходов, см. Меренков
[^2]: г.у. - граничные условия
[^3]: ЗК - закон Кирхгофа
[^4]: ц.ф. - целевая функция
